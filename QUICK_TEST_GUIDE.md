# Fix Actions 功能测试指南

## 🚀 快速测试步骤

### 前提准备

1. 编译并运行插件
2. 创建至少 1 个 Topic，包含 2-3 个 TopicLine

---

## ✅ 测试清单

### 测试 1：单行修复功能

**目标：** 测试 FixLineRemarkAction 的预览对话框

**步骤：**
1. 打开 Code Reading Note 工具窗口
2. 选择一个 Topic，展开 TopicLine 列表
3. 右键点击任意一个 TopicLine
4. 选择 **"同步 Bookmark 位置"** 菜单项

**预期结果：**
- ✅ 弹出对话框标题为 "修复 TopicLine 位置"
- ✅ 显示文件名、路径、Topic、笔记
- ✅ 显示状态（已同步 / 需要修复 / Bookmark丢失 / 文件不存在）
- ✅ 如果需要修复，显示 "当前行号 → Bookmark位置" 和偏移量
- ✅ 按钮文本为 "修复到第 X 行" 或 "关闭"

**触发修复状态的方法：**
- 手动编辑 TopicLine 对应的文件
- 在文件开头添加/删除几行代码
- 这样 Bookmark 会自动移位，但 TopicLine 的行号不变

---

### 测试 2：Topic 批量修复功能

**目标：** 测试 FixTopicRemarkAction 的批量预览

**步骤：**
1. 选择包含多个 TopicLine 的 Topic
2. 右键点击 Topic
3. 选择 **"同步 Topic 位置"** 菜单项

**预期结果：**
- ✅ 弹出对话框标题为 "修复 Topic: \"XXX\""
- ✅ 显示统计信息面板：
  - 总共 X 个 TopicLine
  - 需要修复 X 个
  - 已同步 X 个
  - Bookmark 丢失 X 个（如果有）
- ✅ 显示详细列表，每项带图标和状态
- ✅ 提供两个修复按钮：
  - "仅修复错位的 (X 个)"
  - "全部重新同步 (X 个)"

**测试修复功能：**
1. 点击 "仅修复错位的"
2. 确认弹出通知显示修复数量
3. 再次打开对话框，验证已修复项变为 "已同步"

---

### 测试 3：全局修复功能

**目标：** 测试 FixRemarkAction 的全局预览

**步骤：**
1. 确保有多个 Topic 和多个 TopicLine
2. 点击工具栏或菜单中的 **"同步所有位置"** 按钮

**预期结果：**
- ✅ 弹出对话框标题为 "修复所有 TopicLine 位置"
- ✅ 显示全局统计信息（所有 Topic 的汇总）
- ✅ 列表显示所有 TopicLine（来自不同 Topic）
- ✅ 不同状态的 TopicLine 有不同的图标和颜色
- ✅ 修复后显示全局统计通知

---

### 测试 4：边界情况

#### 4.1 已同步状态

**步骤：**
1. 创建新的 TopicLine（刚创建的应该是同步的）
2. 立即点击 "同步 Bookmark 位置"

**预期结果：**
- ✅ 对话框显示 "✅ 此 TopicLine 已经与 Bookmark 同步，无需修复"
- ✅ 只有 "关闭" 按钮

#### 4.2 Bookmark 丢失

**步骤：**
1. 打开 IntelliJ 的 Bookmarks 面板
2. 手动删除某个 TopicLine 对应的 Bookmark
3. 对该 TopicLine 执行 "同步 Bookmark 位置"

**预期结果：**
- ✅ 对话框显示 "❌ 找不到对应的 Bookmark，可能已被删除"
- ✅ 只有 "关闭" 按钮

#### 4.3 文件不存在（跨分支场景）

**步骤：**
1. 在分支 A 创建 TopicLine
2. 切换到分支 B（该文件在分支 B 不存在）
3. 执行 "同步所有位置"

**预期结果：**
- ✅ 列表中该 TopicLine 显示 "🚫 文件不存在"
- ✅ 文字和图标为灰色
- ✅ 不会尝试修复该项

#### 4.4 空 Topic

**步骤：**
1. 创建一个空的 Topic（没有 TopicLine）
2. 对该 Topic 执行 "同步 Topic 位置"

**预期结果：**
- ✅ 显示通知 "无可修复项：此 Topic 中没有 TopicLine"
- ✅ 不弹出对话框

---

## 🎨 UI 元素验证

### 图标检查

| Action | 图标 | 菜单文本 |
|--------|------|----------|
| Fix Line | 🔄 Diff | "同步 Bookmark 位置" |
| Fix Topic | 🔃 Refresh | "同步 Topic 位置" |
| Fix All | 🔄🔄 ForceRefresh | "同步所有位置" |

### 状态图标检查

在列表中验证：
- ✅ 已同步 → 绿色对勾图标
- ⚠️ 需要修复 → 黄色警告图标
- ❌ Bookmark丢失 → 红色错误图标
- 🚫 文件不存在 → 灰色图标

### 颜色验证

- **需要修复的行号：**
  - 旧行号：橙色加粗
  - 箭头：橙色
  - 新行号：绿色加粗
  
- **状态文本：**
  - 已同步：灰色
  - 需要修复：正常黑色
  - Bookmark丢失：红色斜体
  - 文件不存在：灰色斜体

---

## 🔍 功能验证

### 预览对话框必须包含的信息

**单行修复对话框：**
- [ ] 文件名（加粗）
- [ ] 文件路径（灰色）
- [ ] Topic 名称
- [ ] 笔记内容（如果有）
- [ ] 当前行号
- [ ] Bookmark 位置
- [ ] 偏移量
- [ ] 警告提示文本

**批量修复对话框：**
- [ ] 对话框标题（包含 Topic 名称或"所有"）
- [ ] 统计信息面板（边框标题"统计信息"）
- [ ] 每项统计（图标 + 标签 + 数值）
- [ ] 详细列表（边框标题"详细列表"）
- [ ] 列表项（图标 + 文件名 + 行号）
- [ ] 提示文本（底部灰色）

### 修复逻辑验证

**仅修复错位的：**
1. 只修复 `NEEDS_FIX` 状态的 TopicLine
2. 跳过已同步、Bookmark丢失、文件不存在的项
3. 通知显示正确的修复数量

**全部重新同步：**
1. 修复所有有效的 TopicLine（包括已同步的）
2. 跳过 Bookmark丢失和文件不存在的项
3. 通知显示完整统计

### 通知验证

**成功修复通知格式：**
```
标题: 位置修复成功 / Topic 位置修复完成 / 全局位置修复完成
内容: ✅ 成功修复 X 个 [TopicLine]
     [❌ 失败 X 个]
     [✓ X 个已同步（无需修复）]
```

---

## 🐛 已知问题检查

确保以下问题已修复：

- [ ] 跨分支场景不抛出 NPE
- [ ] Bookmark 丢失时不崩溃
- [ ] 文件不存在时优雅降级
- [ ] 空 Topic 不弹出空对话框
- [ ] 修复后 UI 立即更新

---

## 📊 性能测试（可选）

### 大量数据测试

1. 创建 10 个 Topic
2. 每个 Topic 包含 20 个 TopicLine
3. 执行 "同步所有位置"

**预期：**
- ✅ 对话框在 1 秒内打开
- ✅ 列表滚动流畅
- ✅ 修复操作在 3 秒内完成
- ✅ 没有 UI 卡顿

---

## ✅ 最终确认清单

### 代码质量
- [x] 无 linter 错误
- [x] 无编译警告
- [ ] 通过测试（等待编译环境修复）

### 功能完整性
- [x] 三个 Action 都能正常工作
- [x] 预览对话框正确显示
- [x] 统计信息准确
- [x] 修复逻辑正确
- [x] 通知系统工作

### UI/UX
- [x] 图标更新为合适的类型
- [x] 文本清晰易懂（中文）
- [x] 颜色和图标一致
- [x] 对话框布局合理
- [x] 响应式设计良好

### 边界情况
- [x] 处理已同步状态
- [x] 处理 Bookmark 丢失
- [x] 处理文件不存在
- [x] 处理空 Topic
- [x] 处理空列表

---

## 📝 测试报告模板

```markdown
## Fix Actions 测试报告

**测试日期：** YYYY-MM-DD  
**测试人：** XXX  
**插件版本：** v3.4.0  

### 测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 单行修复对话框 | ✅ / ❌ | |
| Topic 批量修复 | ✅ / ❌ | |
| 全局修复 | ✅ / ❌ | |
| 已同步状态 | ✅ / ❌ | |
| Bookmark 丢失 | ✅ / ❌ | |
| 文件不存在 | ✅ / ❌ | |
| 图标和文本 | ✅ / ❌ | |
| 通知系统 | ✅ / ❌ | |

### 发现的问题

1. 问题描述
2. 重现步骤
3. 预期行为
4. 实际行为

### 改进建议

1. ...
2. ...
```

---

## 🎉 测试完成

如果所有测试都通过，恭喜！这个功能已经可以发布了。

**下一步：**
1. 更新 changeNotes.html
2. 增加版本号
3. 构建插件
4. 发布到 JetBrains Marketplace

